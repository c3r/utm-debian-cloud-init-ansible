- hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Validate ssh_key is defined
      assert:
        that:
          - dev_ssh_key is defined
          - dev_ssh_key | length > 0
        fail_msg: "The SSH key 'dev_ssh_key' is missing or empty in cloud-init/vars.yml. Please ensure it is defined and non-empty."

    - name: Validate IP format (IPv4)
      assert:
        that:
          - item.value.ip is match('^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$')
        fail_msg: "Invalid IP format for {{ item.key }}: {{ item.value.ip }}. Ensure it follows the IPv4 format (e.g., 192.168.1.1)."
      loop: "{{ nodes | dict2items }}"

    - name: Validate static IPs
      assert:
        that:
          - nodes | dict2items | map(attribute='value.ip') | unique | length
            == nodes | length
        fail_msg: "Duplicate IP addresses detected in the 'nodes' variable. Ensure all IPs are unique."

  tasks:
    - name: Ensure parent directory exists
      file:
        path: "{{ playbook_dir }}/{{ cloud_init_dir }}"
        state: directory
        mode: "0777"

    - name: Create build directories
      file:
        path: "{{ playbook_dir }}/{{ cloud_init_dir }}/{{ item.key }}"
        state: directory
        mode: "0777"
      loop: "{{ nodes | dict2items }}"

    - name: Render user-data
      template:
        src: "{{ playbook_dir }}/{{ cloud_init_src }}/templates/user-data.yml.j2"
        dest: "{{ playbook_dir }}/{{ cloud_init_dir }}/{{ item.key }}/user-data"
        mode: "0644"
      loop: "{{ nodes | dict2items }}"
      vars:
        name: "{{ item.key }}"
        ssh_key: "{{ dev_ssh_key }}"
        ip: "{{ item.value.ip | default(omit) }}"

    - name: Render meta-data
      template:
        src: "{{ playbook_dir }}/{{ cloud_init_src }}/templates/meta-data.yml.j2"
        dest: "{{ playbook_dir }}/{{ cloud_init_dir }}/{{ item.key }}/meta-data"
        mode: "0644"
      loop: "{{ nodes | dict2items }}"
      vars:
        hostname: "{{ item.key }}"
        instance_id: "{{ item.key }}"

    - name: Render network-config
      template:
        src: "{{ playbook_dir }}/{{ cloud_init_src }}/templates/network-config.yml.j2"
        dest: "{{ playbook_dir }}/{{ cloud_init_dir }}/{{ item.key }}/network-config"
        mode: "0644"
      loop: "{{ nodes | dict2items }}"
      vars:
        ip: "{{ item.value.ip | default(omit) }}"

    - name: Build seed ISO
      command: >
        xorriso -as mkisofs \
        -volid cidata \
        -joliet \
        -rock \
        -input-charset utf-8 \
        -output {{ playbook_dir }}/{{ cloud_init_dir }}/{{ item.key }}/{{ item.key }}.iso \
        {{ playbook_dir }}/{{ cloud_init_dir }}/{{ item.key }}/user-data \
        {{ playbook_dir }}/{{ cloud_init_dir }}/{{ item.key }}/meta-data \
        {{ playbook_dir }}/{{ cloud_init_dir }}/{{ item.key }}/network-config
      loop: "{{ nodes | dict2items }}"
